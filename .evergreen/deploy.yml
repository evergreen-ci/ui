functions:
  deploy:
    - command: subprocess.exec
      params:
        binary: bash
        args: ["ui/.evergreen/scripts/setup-honeycomb-config.sh"]
    - command: expansions.update
      params:
        redact_file_expansions: true
        file: honeycomb.yml
    - command: subprocess.exec
      params:
        working_dir: ui/${app_dir}
        include_expansions_in_env:
          - BUCKET
          - PARSLEY_SENTRY_AUTH_TOKEN
          - REACT_APP_HONEYCOMB_ENDPOINT
          - REACT_APP_HONEYCOMB_INGEST_KEY
          - REACT_APP_PARSLEY_SENTRY_DSN
          - REACT_APP_SPRUCE_SENTRY_DSN
          - REACT_APP_SPRUCE_URL
          - REACT_APP_EVERGREEN_URL
          - REACT_APP_USER_KEY
          - SPRUCE_SENTRY_AUTH_TOKEN
        env:
          AWS_ACCESS_KEY_ID: ${AWS_ACCESS_KEY_ID}
          AWS_SECRET_ACCESS_KEY: ${AWS_SECRET_ACCESS_KEY}
          AWS_SESSION_TOKEN: ${AWS_SESSION_TOKEN}
        binary: bash
        args: ["../.evergreen/scripts/deploy-with-profiler.sh"]
  email:
    - command: subprocess.exec
      params:
        working_dir: ui/${app_dir}
        env:
          EVERGREEN_API_SERVER_HOST: ${evergreen_api_server_host}
          EVERGREEN_UI_SERVER_HOST: ${evergreen_ui_server_host}
          EVERGREEN_API_KEY: ${evergreen_api_key}
          EVERGREEN_USER: ${evergreen_user}
        binary: bash
        args: ["../.evergreen/scripts/setup-evergreen-config.sh"]
    - command: subprocess.exec
      params:
        working_dir: ui/${app_dir}
        env:
          EXECUTION: ${execution}
          DEPLOYS_EMAIL: ${DEPLOYS_EMAIL}
          AUTHOR_EMAIL: ${author_email}
        binary: bash
        args: ["-c", "${PREPARE_SHELL} && yarn deploy-utils-email"]

  prepare-user-deploy-vars:
    - command: subprocess.exec
      type: setup
      params:
        binary: bash
        args: ["-c", "if ! [ -z \"${staging_user_key}\" ]; then echo \"BUCKET: spruce-${staging_user_key}\" >> deploy-vars.yml && echo \"REACT_APP_USER_KEY: ${staging_user_key}\" >> deploy-vars.yml && echo \"REACT_APP_SPRUCE_URL: https://spruce.${staging_user_key}.evergreen-staging.devprod.mongodb.com\" >> deploy-vars.yml && echo \"REACT_APP_EVERGREEN_URL: https://evergreen-multi.staging.corp.mongodb.com\" >> deploy-vars.yml && echo \"USER_STAGING_ARN: ${user_staging_arn_prefix}${staging_user_key}.ui_put\" >> deploy-vars.yml; else echo \"Must include staging_user_key as a task parameter.\" && exit 1; fi"]
    - command: expansions.update
      params:
        redact_file_expansions: true
        file: deploy-vars.yml

  write-previous-deploy:
    - command: subprocess.exec
      params:
        working_dir: ui/${app_dir}
        binary: bash
        args: ["-c", "${PREPARE_SHELL} && yarn deploy-utils-write-previous-deploy"]

tasks:
  - name: deploy-parsley-staging
    commands:
      - func: symlink
        vars:
          app_dir: apps/parsley
      - func: deploy
        vars:
          app_dir: apps/parsley
          target: staging

  - name: deploy-parsley-beta
    commands:
      - func: symlink
        vars:
          app_dir: apps/parsley
      - func: deploy
        vars:
          app_dir: apps/parsley
          target: beta

  - name: deploy-parsley-prod
    commands:
      - func: write-previous-deploy
      - func: symlink
      - func: deploy
        vars:
          target: production
      - func: email

  - name: deploy-spruce-staging
    commands:
      - func: symlink
        vars:
          app_dir: apps/spruce
      - func: deploy
        vars:
          app_dir: apps/spruce
          target: staging

  - name: deploy-spruce-beta
    commands:
      - func: symlink
        vars:
          app_dir: apps/spruce
      - func: deploy
        vars:
          app_dir: apps/spruce
          target: beta

  - name: deploy-spruce-prod
    commands:
      - func: write-previous-deploy
      - func: symlink
      - func: deploy
        vars:
          target: production
      - func: email

  - name: sync-spruce-staging
    commands:
      - func: prepare-user-deploy-vars
      - func: assume-user-staging-ec2-role
      - func: deploy
        vars:
          app_dir: apps/spruce
          target: staging

parameters:
  - key: profiler
    value: false
    description: Specify whether to include the profiler in the build.
